observe_imeアプリケーション 1.1.0
Copyright (c) 2018 Takeshi Higasa.

● 概要
アクティブなWindowのIMEの状態を取得する。

タスクトレイにインジケータを表示し、インジケータの右クリックでメニューを開き、動作の有効／無効、終了を選択できる。

IMEの状態として以下を検出する。
　IMEが有効かどうか。
 「ひらがな」、「カタカナ」、「ｶﾀｶﾅ」かどうか。

IMEが有効で、ひらがな カタカナ ｶﾀｶﾅ のとき、キーボードのSendInputを使って指定のキーをロックする。結果としてLEDが点灯する。
そうでないときアンロックする。対象のロックキーは、ScrLockまたはNumLockから選択できる。

ScrLock/NumLock LEDの点灯/消灯は、ScrLock/NumLockキーの仮想キーコードの出力によって実現するので、実行中のアプリケーションによっては副作用があるかもしれない。
ScrLockの場合、特にExcelの操作時など注意が必要。
NumLockの場合、テンキーのあるキーボードでのテンキー入力時には大きく影響するが、テンキーレスの場合にはほぼ関係ない。

vserion 1.01より
Windowsのスリープ復帰時に、強制的にScrLock をオフにする。スリープ復帰時のサインインでパスワード入力がNICOLAモードとなってしまって正しいパスワードを入力できないため。
IME状態の問い合わせは、100msec間隔で行うように変更（従来は50msec）。

version 1.02 (2021/7/20)
IME状態通知にNumLockキーを使えるようにした。
IME状態の問い合わせは、200msec間隔で行うようになっている。

version 1.10 (2022/4/1)
IME状態通知をHOBONICO.BINファイルの操作によって実施する機能を追加。
HOBONICO.BINを検索する機能も追加。

-------------

● 実装
非表示のウィンドウを1つもつ。

アクティブなウィンドウのデフォルトIMEウィンドウに対してWM_IME_CONTROLをSendMessage()して状態を問い合わせる。
問い合わせは指定の時間間隔で行う。1.0.2版では200msecに一度。
問い合わせタイミングはWM_TIMERによって得る。

アクティブなGUIスレッドが変化したことを検出できれば、ムダなWM_TIMERを減らすことができるが、どうやるのか知らない。

キーが押されたふりをするときは、keybd_event() ではなく、SendInput()というAPIを使う。

スリープに入るとき、ScrLock/Numlockを解除する。そうしないと復帰時にScrLock/NumLockがオンのままになりサインイン情報が正しく入力できないことがある。
WM_POWERBROADCASTメッセージを受けたとき、wParamがPBT_APMSUSPENDかPBT_APMRESUMEAUTOMATICのとき、ScrLock/NumLOckをオフにする。サスペンド時は効果がないが、リジューム時には効果があった。デスクトップ回復後フォーカスウィンドウが日本語入力状態ならば、IME監視機能によってその時点でScrLockはオンになる。2018/12/08


*** LICENSE
observe_ime application is released under  the MIT License.

Copyright 2018 Takeshi Higasa, okiraku-camera.tokyo.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

